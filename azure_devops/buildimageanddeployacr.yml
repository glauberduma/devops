# Template: buildimageanddeployacr.yml
# Objetivo: Gera uma imagem Docker, escaneia vulnerabilidades com Trivy e faz o deploy no Azure Container Registry (ACR).
#           Opcionalmente, reinicia uma Azure Container App para utilizar a nova imagem.
#
# Par√¢metros:
#   ACR_NAME                   : (Obrigat√≥rio) Nome do Azure Container Registry.
#   IMAGE_NAME                 : (Obrigat√≥rio) Nome da imagem a ser gerada.
#   DOCKER_FILE                : (Obrigat√≥rio) Caminho/Nome do Dockerfile.
#   TRIVY_SEVERITY             : (Opcional) N√≠vel de severidade para falha (CRITICAL, HIGH, MEDIUM, LOW). Default: CRITICAL.
#   RESTART_CONTAINER          : (Opcional) 'S' para reiniciar a Azure Container App ap√≥s o deploy. Default: 'N'.
#   AZURE_RESOURCE_GROUP       : (Opcional) Resource Group da Container App (Obrigat√≥rio se RESTART_CONTAINER='S').
#   AZURE_CONTAINERAPP_NAME    : (Opcional) Nome da Container App (Obrigat√≥rio se RESTART_CONTAINER='S').
#
#   AZURE_SERVICE_CONNECTION   : (Opcional) Nome da Service Connection do Azure DevOps para autentica√ß√£o no Azure (Substitui o JSON credentials).
#   DOCKER_USERNAME            : (Obrigat√≥rio) Usu√°rio para login no ACR (passar via variable group ou runtime).
#   DOCKER_PASSWORD            : (Obrigat√≥rio) Senha para login no ACR (passar via variable group ou runtime).

parameters:
  - name: ACR_NAME
    type: string
  - name: IMAGE_NAME
    type: string
  - name: DOCKER_FILE
    type: string
  - name: TRIVY_SEVERITY
    type: string
    default: 'CRITICAL'
  - name: RESTART_CONTAINER
    type: string
    default: 'N'
  - name: AZURE_RESOURCE_GROUP
    type: string
    default: ''
  - name: AZURE_CONTAINERAPP_NAME
    type: string
    default: ''
  - name: AZURE_SERVICE_CONNECTION
    type: string
    default: ''
  - name: DOCKER_USERNAME
    type: string
  - name: DOCKER_PASSWORD
    type: string

steps:
  - checkout: self
    fetchDepth: 0
    displayName: 'üèó Checkout repository'

  - script: |
      docker build -t ${{ parameters.ACR_NAME }}/${{ parameters.IMAGE_NAME }}:$(Build.BuildId) -t ${{ parameters.ACR_NAME }}/${{ parameters.IMAGE_NAME }}:latest -f ${{ parameters.DOCKER_FILE }} .
    displayName: 'üöÄ Build an image $(Build.BuildId)'

  - script: |
      echo "üîç Executando Trivy Scan..."
      # Executa Trivy via Docker para n√£o depender de instala√ß√£o no agente
      docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $(pwd):/scan aquasec/trivy image \
        --severity ${{ parameters.TRIVY_SEVERITY }} \
        --exit-code 1 \
        --format table \
        ${{ parameters.ACR_NAME }}/${{ parameters.IMAGE_NAME }}:latest
    displayName: 'üîç Trivy - Vulnerability Scan'

  - script: |
      echo "üö® VULNERABILIDADES ENCONTRADAS! üö®"
      echo "A pipeline falhou devido a vulnerabilidades de n√≠vel '${{ parameters.TRIVY_SEVERITY }}' ou superior."
      echo "Verifique o log da etapa anterior para detalhes."
    displayName: '‚ùå Security Check Failed'
    condition: failed()

  - script: |
      echo "${{ parameters.DOCKER_PASSWORD }}" | docker login ${{ parameters.ACR_NAME }} -u ${{ parameters.DOCKER_USERNAME }} --password-stdin
    displayName: 'üöÄ Login to ACR'

  - script: |
      docker push ${{ parameters.ACR_NAME }}/${{ parameters.IMAGE_NAME }}:latest
    displayName: 'üöÄ Push an image latest'

  - script: |
      docker push ${{ parameters.ACR_NAME }}/${{ parameters.IMAGE_NAME }}:$(Build.BuildId)
    displayName: 'üöÄ Push an image $(Build.BuildId)'

  - script: |
      docker logout ${{ parameters.ACR_NAME }}
    displayName: 'Docker Logout'
    condition: always()

  - task: AzureCLI@2
    displayName: 'üîÅ Restart Azure Container Apps revisions'
    condition: eq('${{ parameters.RESTART_CONTAINER }}', 'S')
    inputs:
      azureSubscription: ${{ parameters.AZURE_SERVICE_CONNECTION }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -euo pipefail
        RG="${{ parameters.AZURE_RESOURCE_GROUP }}"
        APP="${{ parameters.AZURE_CONTAINERAPP_NAME }}"

        if [ -z "$RG" ] || [ -z "$APP" ]; then
          echo "AZURE_RESOURCE_GROUP e AZURE_CONTAINERAPP_NAME s√£o obrigat√≥rios quando RESTART_CONTAINER = 'S'."
          exit 1
        fi

        echo "üí° Garantindo extens√£o containerapp instalada..."
        az extension add --name containerapp --yes --upgrade

        echo "‚ÑπÔ∏è Container App: $APP | RG: $RG"
        
        echo "üîé Buscando revis√µes ativas..."
        REVISIONS=$(az containerapp revision list -n "$APP" -g "$RG" --query "[?properties.active==\`true\`].name" -o tsv)
        
        if [ -z "$REVISIONS" ]; then
          echo "Nenhuma revis√£o ativa encontrada para $APP."
          exit 1
        fi

        for REV in $REVISIONS; do
          echo "üîÅ Reiniciando revis√£o: $REV"
          az containerapp revision restart -n "$APP" -g "$RG" --revision "$REV"
        done

        echo "‚úÖ Rein√≠cio solicitado para todas as revis√µes ativas."
